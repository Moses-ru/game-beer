<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Beer Stack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: linear-gradient(to top, #0f2027, #203a43, #2c5364);
    }
    canvas {
      display: block;
    }
    #restart {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      z-index: 10;
      display: none;
    }
  </style>
</head>
<body>
<button id="restart">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
<canvas id="game"></canvas>
<audio id="bg-music" src="music.mp3" loop></audio>
<div id="score" style="
  position: absolute;
  top: 20px;
  left: 20px;
  color: white;
  font-size: 20px;
  font-weight: bold;
  font-family: sans-serif;
  z-index: 10;
">üç∫ 0</div>
<div id="leaderboard" style="
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(0,0,0,0.5);
  color: white;
  font-size: 14px;
  padding: 10px;
  box-sizing: border-box;
  font-family: sans-serif;
  max-height: 120px;
  overflow-y: auto;
  display: none;
"></div>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let W = window.innerWidth;
let H = window.innerHeight;
canvas.width = W;
canvas.height = H;

const blockHeight = 40;
const initialWidth = 200;
let speed = 0; // –û—Ç–∫–ª—é—á–µ–Ω–æ –≤ –Ω–∞—á–∞–ª–µ
let gameStarted = false;
let direction = 1;
let level = 0;
let gameOver = false;
let cameraOffset = 0;
let targetCameraOffset = 0;
const stack = [];
const beerImage = new Image();
beerImage.src = 'beer-glass.png';

function newBlock(width) {
  return {
    x: (W - width) / 2, // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
    y: H - blockHeight * (stack.length + 1),
    width,
    spawnProgress: 0
  };
}
let current = newBlock(initialWidth);

function drawBlock(block) {
  let screenY = block.y + cameraOffset;
  if (block.spawnProgress < 1) screenY -= (1 - block.spawnProgress) * 80;
  if (beerImage.complete && beerImage.naturalWidth) {
    ctx.save();
    ctx.beginPath();
    ctx.rect(block.x, screenY, block.width, blockHeight);
    ctx.clip();
    ctx.drawImage(beerImage, block.x, screenY, beerImage.width, blockHeight);
    ctx.restore();
  } else {
    ctx.fillStyle = "#ffcc00";
    ctx.fillRect(block.x, screenY, block.width, blockHeight);
  }
}

function draw() {
  ctx.clearRect(0, 0, W, H);
  stack.forEach(drawBlock);
  drawBlock(current);
}

function update() {
  if (gameOver) return;
  if (current.spawnProgress < 1) current.spawnProgress += 0.05;
  cameraOffset += (targetCameraOffset - cameraOffset) * 0.1;
  current.x += speed * direction;
  if (current.x + current.width > W || current.x < 0) direction *= -1;
  document.getElementById("score").textContent = `üç∫ ${level}`;
}

function placeBlock() {
  if (gameOver) return;
  if (navigator.vibrate) navigator.vibrate(50);
  const last = stack[stack.length - 1];
  if (last) {
    const delta = current.x - last.x;
    const overlap = current.width - Math.abs(delta);
    if (overlap <= 5) {
      gameOver = true;
      document.getElementById("restart").style.display = "block";
      if (Telegram.WebApp && Telegram.WebApp.sendScore) {
        Telegram.WebApp.sendScore(level);
      }
      return;
    }
    current.width = overlap;
    current.x = delta > 0 ? current.x : last.x;
  }
  stack.push({ ...current });
  level++;
  targetCameraOffset += blockHeight * 0.8;
  current = newBlock(current.width);
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

function restartGame() {
  stack.length = 0;
  current = newBlock(initialWidth);
  level = 0;
  gameOver = false;
  cameraOffset = 0;
  targetCameraOffset = 0;
  document.getElementById("restart").style.display = "none";
  document.getElementById("score").textContent = `üç∫ 0`;
}

canvas.addEventListener("pointerdown", () => {
  if (!gameStarted) {
    speed = 6; // –í–∫–ª—é—á–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞
    gameStarted = true;
  }
  document.getElementById("bg-music")?.play().catch(() => {});
  placeBlock();
}, { once: true });

document.body.addEventListener("pointerdown", placeBlock);
document.getElementById("restart").addEventListener("click", restartGame);

if (typeof Telegram !== "undefined") {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}

function loadLeaderboard() {
  if (!Telegram.WebApp.initDataUnsafe?.user) return;
  Telegram.WebApp.getGameHighScores(Telegram.WebApp.initDataUnsafe.user.id, (scores) => {
    if (!scores?.length) return;
    const leaderboard = document.getElementById("leaderboard");
    leaderboard.innerHTML = "<b>üèÜ –õ–∏–¥–µ—Ä—ã:</b><br>";
    scores.forEach((entry, index) => {
      const user = entry.user.username || `${entry.user.first_name || "–ò–≥—Ä–æ–∫"} ${entry.user.last_name || ""}`;
      leaderboard.innerHTML += `${index + 1}. ${user}: ${entry.score}<br>`;
    });
    leaderboard.style.display = "block";
  });
}

loadLeaderboard();
loop();
</script>
</body>
</html>
